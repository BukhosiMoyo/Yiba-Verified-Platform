generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Institution {
  institution_id                  String                     @id @default(uuid())
  legal_name                      String
  trading_name                    String?
  institution_type                InstitutionType
  registration_number             String
  tax_compliance_pin              String?
  physical_address                String
  postal_address                  String?
  province                        String
  delivery_modes                  DeliveryMode[]
  status                          RecordStatus               @default(DRAFT)
  contact_person_name             String?
  contact_email                   String?
  contact_number                  String?
  created_at                      DateTime                   @default(now())
  updated_at                      DateTime                   @updatedAt
  deleted_at                      DateTime?
  branch_code                     String?                    @unique
  parent_institution_id           String?
  offers_web_based_learning       Boolean?
  offers_workplace_based_learning Boolean?
  profile_completeness            Int                        @default(0)
  announcements                   Announcement[]
  auditLogs                       AuditLog[]                 @relation("InstitutionAuditLogs")
  cohorts                         Cohort[]
  complianceAuditLogs             ComplianceAuditLog[]
  supportChats                    Conversation[]             @relation("InstitutionSupportChats")
  documents                       Document[]                 @relation("DocumentInstitution")
  enrolments                      Enrolment[]
  parent                          Institution?               @relation("InstitutionBranches", fields: [parent_institution_id], references: [institution_id])
  branches                        Institution[]              @relation("InstitutionBranches")
  compliance                      InstitutionCompliance?
  contacts                        InstitutionContact[]
  leads                           InstitutionLead[]
  publicPosts                     InstitutionPost[]
  publicProfile                   InstitutionPublicProfile?
  approvedQualifications          InstitutionQualification[]
  reviews                         InstitutionReview[]
  trustScore                      InstitutionTrustScore?
  invites                         Invite[]
  issueReports                    IssueReport[]              @relation("InstitutionIssueReports")
  learners                        Learner[]
  qctoRequests                    QCTORequest[]
  readinessRecords                Readiness[]
  submissions                     Submission[]
  users                           User[]
  userInstitutions                UserInstitution[]

  questionnaireResponses QuestionnaireResponse[]

  @@index([registration_number])
  @@index([province])
  @@index([parent_institution_id])
}

/// Regulatory snapshot. Sidecar to Institution to keep main table clean.
model InstitutionCompliance {
  id                   String      @id @default(uuid())
  institution_id       String      @unique
  accreditation_status String
  accreditation_number String?
  approval_date        DateTime?
  expiry_date          DateTime?
  provinces_approved   String[]
  delivery_modes       String[]
  last_synced_at       DateTime?
  updated_at           DateTime    @updatedAt
  institution          Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([accreditation_status])
  @@index([accreditation_number])
}

/// Explicit approval link between Institution and Qualification (Registry)
model InstitutionQualification {
  id                 String                 @id @default(uuid())
  institution_id     String
  qualification_id   String?
  registry_id        String?
  approval_status    String                 @default("APPROVED")
  scope_start_date   DateTime?
  scope_end_date     DateTime?
  learner_intake_cap Int?
  created_at         DateTime               @default(now())
  updated_at         DateTime               @updatedAt
  institution        Institution            @relation(fields: [institution_id], references: [institution_id])
  registry           QualificationRegistry? @relation(fields: [registry_id], references: [id])

  @@unique([institution_id, registry_id])
  @@index([institution_id])
  @@index([registry_id])
}

/// Governance & Compliance Contacts (distinct from Users)
model InstitutionContact {
  id             String       @id @default(uuid())
  institution_id String?
  type           String
  first_name     String
  last_name      String
  email          String
  phone_number   String?
  source         String       @default("MANUAL")
  visibility     String       @default("INTERNAL_ONLY")
  user_id        String?
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt
  institution    Institution? @relation(fields: [institution_id], references: [institution_id])
  user           User?        @relation(fields: [user_id], references: [user_id])

  @@index([email])
  @@index([institution_id])
  @@index([type])
}

/// Append-only log for compliance status changes
model ComplianceAuditLog {
  id             String      @id @default(uuid())
  institution_id String
  changed_by     String
  change_type    String
  previous_value Json?
  new_value      Json?
  reason         String?
  created_at     DateTime    @default(now())
  institution    Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([institution_id])
  @@index([created_at])
}

model User {
  user_id                         String                       @id @default(uuid())
  institution_id                  String?
  role                            UserRole
  first_name                      String
  last_name                       String
  email                           String                       @unique
  emailVerified                   DateTime?
  phone                           String?
  password_hash                   String?
  status                          String                       @default("ACTIVE")
  image                           String?
  created_at                      DateTime                     @default(now())
  updated_at                      DateTime                     @updatedAt
  deleted_at                      DateTime?
  qcto_id                         String?
  onboarding_completed            Boolean                      @default(false)
  onboarding_completed_at         DateTime?
  default_province                String?
  assigned_provinces              String[]                     @default([])
  phone_verified                  Boolean                      @default(false)
  phone_verified_at               DateTime?
  phone_otp_code                  String?
  phone_otp_expires               DateTime?
  verification_level              VerificationLevel            @default(NONE)
  verification_date               DateTime?
  verification_fast_track         Boolean                      @default(false)
  profile_completeness            Int                          @default(0)
  reviews_completed               Int                          @default(0)
  violation_count                 Int                          @default(0)
  last_violation_at               DateTime?
  last_active_at                  DateTime?                    @default(now())
  facilitator_id_number           String?
  facilitator_industry_experience String?
  facilitator_profile_complete    Boolean                      @default(false)
  facilitator_qualifications      String?
  two_factor_backup_codes         String[]                     @default([])
  two_factor_enabled              Boolean                      @default(false)
  two_factor_secret               String?
  accounts                        Account[]
  announcements                   Announcement[]               @relation("UserAnnouncements")
  assessedResults                 AssessmentResult[]           @relation("UserAssessed")
  attendanceMarkedBy              AttendanceRecord[]           @relation("UserAttendanceMarkedBy")
  auditLogs                       AuditLog[]                   @relation("AuditChangedBy")
  blogPosts                       BlogPost[]                   @relation("BlogPostAuthor")
  clientErrorReports              ClientErrorReport[]
  createdConversations            Conversation[]               @relation("ConversationCreator")
  conversationMemberships         ConversationMember[]         @relation("UserConversations")
  cvVersions                      CvVersion[]
  uploadedDocuments               Document[]                   @relation("UserUploadedDocuments")
  documents                       Document[]                   @relation("DocumentInstitution")
  documentFlags                   DocumentFlag[]
  emailQueueItems                 EmailQueue[]
  evidenceFlags                   EvidenceFlag[]               @relation("EvidenceFlaggedBy")
  evidenceResolved                EvidenceFlag[]               @relation("EvidenceResolvedBy")
  readinessFacilitatorLinks       Facilitator[]                @relation("FacilitatorLinkedUser")
  verifiedFacilitators            Facilitator[]                @relation("UserVerifiedFacilitator")
  impersonations                  ImpersonationSession[]       @relation("Impersonations")
  impersonated                    ImpersonationSession[]       @relation("Impersonated")
  institutionContacts             InstitutionContact[]
  institutionPostFlags            InstitutionPostFlag[]
  institutionReviews              InstitutionReview[]
  createdInvites                  Invite[]                     @relation("UserCreatedInvites")
  createdCampaigns                InviteCampaign[]             @relation("UserCreatedCampaigns")
  assignedIssues                  IssueReport[]                @relation("UserAssignedIssues")
  issueReports                    IssueReport[]                @relation("UserIssueReports")
  jobRequestsReceived             JobOpportunityRequest[]      @relation("JobRequestsCandidate")
  learner                         Learner?                     @relation("StudentLearner")
  sentMessages                    Message[]                    @relation("UserMessages")
  messageReactions                MessageReaction[]            @relation("UserReactions")
  notifications                   Notification[]               @relation("UserNotifications")
  notificationPreferences         NotificationPreference[]
  onboardingProgress              OnboardingProgress?
  publicTalentProfile             PublicTalentProfile?
  createdQctoInvites              QCTOInvite[]                 @relation("QCTOInviteInvitedBy")
  assignedQctoRequests            QCTORequest[]                @relation("QctoRequestReviewer")
  requestedQCTORequests           QCTORequest[]                @relation("QCTORequested")
  reviewedQCTORequests            QCTORequest[]                @relation("InstitutionReviewed")
  qctoAssignmentsAssignedBy       QctoAssignment[]             @relation("QctoAssignmentsAssignedBy")
  qctoAssignmentsAssignedTo       QctoAssignment[]             @relation("QctoAssignmentsAssignedTo")
  qualificationRegistryCreated    QualificationRegistry[]      @relation("QualificationRegistryCreatedBy")
  qualificationRegistryUpdated    QualificationRegistry[]      @relation("QualificationRegistryUpdatedBy")
  readinessRecommendations        ReadinessRecommendation[]    @relation("ReadinessRecommendedBy")
  readinessSectionReviews         ReadinessSectionReview[]
  reviewAssignmentsBy             ReviewAssignment[]           @relation("ReviewAssignmentsBy")
  reviewAssignments               ReviewAssignment[]           @relation("ReviewAssignments")
  reviewComments                  ReviewComment[]              @relation("ReviewCommentsBy")
  serviceRequestsAssigned         ServiceRequest[]             @relation("ServiceRequestsAssigned")
  sessions                        Session[]
  reviewedSubmissions             Submission[]                 @relation("UserReviewed")
  submittedSubmissions            Submission[]                 @relation("UserSubmitted")
  addedResources                  SubmissionResource[]         @relation("UserAddedResource")
  reviewAttachmentsUploaded       SubmissionReviewAttachment[] @relation("UserUploadedReviewAttachments")
  talentLikes                     TalentLike[]
  institution                     Institution?                 @relation(fields: [institution_id], references: [institution_id])
  qctoOrg                         QCTOOrg?                     @relation(fields: [qcto_id], references: [id])
  activityLogs                    UserActivityLog[]
  userInstitutions                UserInstitution[]            @relation("UserInstitutions")
  userServiceLeads                UserServiceLead[]
  emailChangeRequests             EmailChangeRequest[]

  @@index([institution_id])
  @@index([qcto_id])
  @@index([role])
  @@index([default_province])
}

/// Many-to-many: user can belong to multiple institutions (e.g. branches). Role within the institution (ADMIN/STAFF).
/// can_facilitate/can_assess/can_moderate: when true, user can be selected as facilitator/assessor/moderator in Form 5.
model UserInstitution {
  user_id        String
  institution_id String
  role           UserInstitutionRole @default(ADMIN)
  is_primary     Boolean             @default(false)
  created_at     DateTime            @default(now())
  can_assess     Boolean             @default(false)
  can_facilitate Boolean             @default(false)
  can_moderate   Boolean             @default(false)
  institution    Institution         @relation(fields: [institution_id], references: [institution_id], onDelete: Cascade)
  user           User                @relation("UserInstitutions", fields: [user_id], references: [user_id], onDelete: Cascade)

  @@id([user_id, institution_id])
  @@index([user_id])
  @@index([institution_id])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Readiness {
  readiness_id                          String                   @id @default(uuid())
  institution_id                        String
  qualification_title                   String
  saqa_id                               String
  nqf_level                             Int?
  curriculum_code                       String
  delivery_mode                         DeliveryMode
  readiness_status                      ReadinessStatus          @default(NOT_STARTED)
  submission_date                       DateTime?
  created_at                            DateTime                 @default(now())
  updated_at                            DateTime                 @updatedAt
  deleted_at                            DateTime?
  facilitator_learner_ratio             String?
  number_of_training_rooms              Int?
  ownership_type                        String?
  professional_body_registration        Boolean?
  registration_type                     String?
  room_capacity                         Int?
  self_assessment_completed             Boolean?
  self_assessment_remarks               String?
  training_site_address                 String?
  curriculum_alignment_confirmed        Boolean?
  knowledge_module_coverage             Int?
  learning_material_exists              Boolean?
  practical_module_coverage             Int?
  accessibility_for_disabilities        Boolean?
  emergency_exits_marked                Boolean?
  fire_extinguisher_available           Boolean?
  fire_extinguisher_service_date        DateTime?
  first_aid_kit_available               Boolean?
  ohs_representative_name               String?
  backup_frequency                      String?
  data_storage_description              String?
  internet_connectivity_method          String?
  isp                                   String?
  lms_name                              String?
  max_learner_capacity                  Int?
  security_measures_description         String?
  policies_procedures_notes             String?
  wbl_agreement_duration                String?
  wbl_agreement_type                    String?
  wbl_assessment_responsibility         String?
  wbl_components_covered                String?
  wbl_learner_support_description       String?
  wbl_workplace_partner_name            String?
  credits                               Int?
  intended_learner_intake               Int?
  knowledge_components_complete         Boolean?
  learning_material_coverage_percentage Int?
  learning_material_nqf_aligned         Boolean?
  learning_material_quality_verified    Boolean?
  lmis_access_control_description       String?
  lmis_data_storage_description         String?
  lmis_functional                       Boolean?
  lmis_popia_compliant                  Boolean?
  occupational_category                 String?
  practical_components_complete         Boolean?
  section_completion_data               Json?
  section_criteria_responses            Json?
  qualification_registry_id             String?
  qualification_snapshot                Json?
  qualification_id                      String?
  qualification_snapshot_json           Json?
  documents                             Document[]               @relation("DocumentInstitution")
  documentFlags                         DocumentFlag[]
  facilitators                          Facilitator[]
  institution                           Institution              @relation(fields: [institution_id], references: [institution_id])
  qualification                         Qualification?           @relation(fields: [qualification_id], references: [qualification_id])
  qualification_registry                QualificationRegistry?   @relation(fields: [qualification_registry_id], references: [id])
  recommendation                        ReadinessRecommendation?
  sectionReviews                        ReadinessSectionReview[]

  @@index([institution_id])
  @@index([saqa_id])
  @@index([readiness_status])
  @@index([qualification_registry_id])
  @@index([qualification_id])
}

model Learner {
  learner_id               String              @id @default(uuid())
  institution_id           String
  user_id                  String?             @unique
  national_id              String              @unique
  alternate_id             String?
  first_name               String
  last_name                String
  birth_date               DateTime
  gender_code              String
  nationality_code         String
  home_language_code       String?
  disability_status        String
  popia_consent            Boolean
  consent_date             DateTime
  created_at               DateTime            @default(now())
  updated_at               DateTime            @updatedAt
  deleted_at               DateTime?
  address                  String?
  ethnicity                String?
  next_of_kin_address      String?
  next_of_kin_name         String?
  next_of_kin_phone        String?
  next_of_kin_relationship String?
  province                 String?
  public_profile_id        String?             @unique
  public_profile_enabled   Boolean             @default(false)
  public_bio               String?
  public_skills            String[]            @default([])
  public_projects          Json?
  documents                Document[]          @relation("DocumentInstitution")
  enrolments               Enrolment[]
  institution              Institution         @relation(fields: [institution_id], references: [institution_id])
  user                     User?               @relation("StudentLearner", fields: [user_id], references: [user_id])
  pastQualifications       PastQualification[]
  priorLearning            PriorLearning[]

  @@index([institution_id])
  @@index([national_id])
  @@index([user_id])
  @@index([public_profile_id])
}

model Qualification {
  qualification_id     String              @id @default(uuid())
  name                 String
  code                 String              @unique
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt
  deleted_at           DateTime?
  assessment_type      AssessmentType?
  career_outcomes      String[]
  credits              Int?
  curriculum_code      String?             @unique
  duration_unit        DurationUnit        @default(MONTHS)
  duration_value       Int                 @default(12)
  entry_requirements   String?
  language_of_delivery String?
  modules              String[]
  nqf_level            Int                 @default(1)
  regulatory_body      RegulatoryBody?
  saqa_id              String?             @unique
  seta                 String?
  status               QualificationStatus @default(DRAFT)
  study_mode           StudyMode           @default(ON_SITE)
  summary              String?
  type                 QualificationType   @default(OTHER)
  workplace_hours      Int?
  workplace_required   Boolean             @default(false)
  cohorts              Cohort[]
  enrolments           Enrolment[]
  readinessRecords     Readiness[]

  @@index([code])
  @@index([status])
  @@index([saqa_id])
}

/// Canonical qualification list (SAQA/NQF/curriculum) â€” single source of truth for Form 5 readiness.
model QualificationRegistry {
  id                        String                     @id @default(cuid())
  name                      String
  code                      String?
  saqa_id                   String?                    @unique
  curriculum_code           String?                    @unique
  nqf_level                 Int?
  credits                   Int?
  occupational_category     String?
  description               String?
  status                    QualificationStatus        @default(ACTIVE)
  effective_from            DateTime?
  effective_to              DateTime?
  created_by_id             String?
  updated_by_id             String?
  created_at                DateTime                   @default(now())
  updated_at                DateTime                   @updatedAt
  deleted_at                DateTime?
  institutionQualifications InstitutionQualification[]
  aliases                   QualificationAlias[]
  createdBy                 User?                      @relation("QualificationRegistryCreatedBy", fields: [created_by_id], references: [user_id])
  updatedBy                 User?                      @relation("QualificationRegistryUpdatedBy", fields: [updated_by_id], references: [user_id])
  versions                  QualificationVersion[]
  readiness_records         Readiness[]

  @@index([status])
  @@index([name])
}

model QualificationAlias {
  id          String                @id @default(cuid())
  registry_id String
  alias       String
  source      AliasSource           @default(QCTO)
  created_at  DateTime              @default(now())
  registry    QualificationRegistry @relation(fields: [registry_id], references: [id], onDelete: Cascade)

  @@unique([registry_id, alias])
  @@index([alias])
}

model QualificationVersion {
  id            String                @id @default(cuid())
  registry_id   String
  version_label String
  snapshot_json Json
  created_at    DateTime              @default(now())
  registry      QualificationRegistry @relation(fields: [registry_id], references: [id], onDelete: Cascade)

  @@index([registry_id])
}

model Enrolment {
  enrolment_id             String             @id @default(uuid())
  learner_id               String
  institution_id           String
  qualification_title      String
  start_date               DateTime
  expected_completion_date DateTime?
  enrolment_status         EnrolmentStatus    @default(ACTIVE)
  attendance_percentage    Decimal?           @db.Decimal(5, 2)
  assessment_centre_code   String?
  readiness_status         String?
  flc_status               String?
  statement_number         String?
  created_at               DateTime           @default(now())
  updated_at               DateTime           @updatedAt
  deleted_at               DateTime?
  qualification_id         String?
  cohort_id                String?
  assessments              Assessment[]
  attendanceRecords        AttendanceRecord[]
  documents                Document[]         @relation("DocumentInstitution")
  cohort                   Cohort?            @relation(fields: [cohort_id], references: [cohort_id])
  institution              Institution        @relation(fields: [institution_id], references: [institution_id])
  learner                  Learner            @relation(fields: [learner_id], references: [learner_id])
  qualification            Qualification?     @relation(fields: [qualification_id], references: [qualification_id])
  moduleCompletions        ModuleCompletion[]

  @@index([institution_id])
  @@index([learner_id])
  @@index([enrolment_status])
  @@index([qualification_id])
  @@index([cohort_id])
}

model Cohort {
  cohort_id        String         @id @default(uuid())
  institution_id   String
  qualification_id String
  name             String
  start_date       DateTime?
  end_date         DateTime?
  status           String         @default("ACTIVE")
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt
  sessions         ClassSession[]
  institution      Institution    @relation(fields: [institution_id], references: [institution_id])
  qualification    Qualification  @relation(fields: [qualification_id], references: [qualification_id])
  enrolments       Enrolment[]
  facilitators     Facilitator[]  @relation("CohortToFacilitator")

  @@index([institution_id])
  @@index([qualification_id])
}

model ClassSession {
  session_id        String             @id @default(uuid())
  cohort_id         String
  date              DateTime
  start_time        String?
  end_time          String?
  session_type      SessionType        @default(THEORY)
  location          String?
  notes             String?
  is_locked         Boolean            @default(false)
  locked_at         DateTime?
  locked_by_user_id String?
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  attendanceRecords AttendanceRecord[]
  cohort            Cohort             @relation(fields: [cohort_id], references: [cohort_id])

  @@index([cohort_id])
  @@index([date])
}

/// One row per learner per date per enrolment. PRESENT, LATE, EXCUSED count as attended for percentage.
model AttendanceRecord {
  record_id    String           @id @default(uuid())
  enrolment_id String
  record_date  DateTime         @db.Date
  status       AttendanceStatus
  marked_at    DateTime         @default(now())
  marked_by    String
  notes        String?
  minutes_late Int?
  session_id   String?
  enrolment    Enrolment        @relation(fields: [enrolment_id], references: [enrolment_id], onDelete: Cascade)
  markedByUser User             @relation("UserAttendanceMarkedBy", fields: [marked_by], references: [user_id])
  classSession ClassSession?    @relation(fields: [session_id], references: [session_id])
  sickNote     SickNote?

  @@unique([enrolment_id, record_date])
  @@index([enrolment_id])
  @@index([record_date])
  @@index([status])
  @@index([session_id])
}

/// Sick note for an excused/absent record. Reason required; document (e.g. medical certificate) optional.
model SickNote {
  sick_note_id     String           @id @default(uuid())
  record_id        String           @unique
  reason           String
  document_id      String?          @unique
  created_at       DateTime         @default(now())
  updated_at       DateTime         @updatedAt
  document         Document?        @relation("SickNoteDocument", fields: [document_id], references: [document_id])
  attendanceRecord AttendanceRecord @relation(fields: [record_id], references: [record_id], onDelete: Cascade)

  @@index([record_id])
}

/// *
///  * Assessment
///  * Tracks assessments/exams for enrolments (knowledge tests, practical assessments, etc.)
model Assessment {
  assessment_id   String             @id @default(uuid())
  enrolment_id    String
  assessment_type String
  assessment_name String
  assessment_date DateTime
  total_marks     Int?
  passing_marks   Int?
  created_at      DateTime           @default(now())
  updated_at      DateTime           @updatedAt
  deleted_at      DateTime?
  enrolment       Enrolment          @relation(fields: [enrolment_id], references: [enrolment_id])
  results         AssessmentResult[]

  @@index([enrolment_id])
  @@index([assessment_date])
  @@index([assessment_type])
}

/// *
///  * AssessmentResult
///  * Stores individual assessment results (marks, grades, pass/fail)
model AssessmentResult {
  result_id      String     @id @default(uuid())
  assessment_id  String
  module_name    String?
  marks_obtained Int?
  percentage     Decimal?   @db.Decimal(5, 2)
  grade          String?
  passed         Boolean?
  remarks        String?
  assessed_by    String?
  assessed_at    DateTime?
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt
  assessedByUser User?      @relation("UserAssessed", fields: [assessed_by], references: [user_id])
  assessment     Assessment @relation(fields: [assessment_id], references: [assessment_id], onDelete: Cascade)

  @@index([assessment_id])
  @@index([assessed_by])
  @@index([module_name])
}

/// *
///  * ModuleCompletion
///  * Tracks completion of curriculum modules/units with grades
model ModuleCompletion {
  completion_id   String       @id @default(uuid())
  enrolment_id    String
  module_name     String
  module_code     String?
  module_type     String
  completion_date DateTime?
  status          String
  final_grade     String?
  marks_obtained  Int?
  percentage      Decimal?     @db.Decimal(5, 2)
  facilitator_id  String?
  notes           String?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  enrolment       Enrolment    @relation(fields: [enrolment_id], references: [enrolment_id])
  facilitator     Facilitator? @relation(fields: [facilitator_id], references: [facilitator_id])

  @@index([enrolment_id])
  @@index([facilitator_id])
  @@index([status])
  @@index([module_type])
}

model Document {
  document_id        String                            @id @default(uuid())
  related_entity     DocumentRelatedEntity
  related_entity_id  String
  document_type      String
  file_name          String
  version            Int
  status             DocumentStatus                    @default(UPLOADED)
  uploaded_by        String
  uploaded_at        DateTime                          @default(now())
  storage_key        String?
  mime_type          String?
  file_size_bytes    Int?
  uploadedByUser     User                              @relation("UserUploadedDocuments", fields: [uploaded_by], references: [user_id])
  enrolment          Enrolment?                        @relation("DocumentInstitution", fields: [related_entity_id], references: [enrolment_id], map: "fk_doc_enrolment")
  facilitator        Facilitator?                      @relation("DocumentInstitution", fields: [related_entity_id], references: [facilitator_id], map: "fk_doc_facilitator")
  institution        Institution?                      @relation("DocumentInstitution", fields: [related_entity_id], references: [institution_id], map: "fk_doc_institution")
  learner            Learner?                          @relation("DocumentInstitution", fields: [related_entity_id], references: [learner_id], map: "fk_doc_learner")
  readiness          Readiness?                        @relation("DocumentInstitution", fields: [related_entity_id], references: [readiness_id], map: "fk_doc_readiness")
  user               User?                             @relation("DocumentInstitution", fields: [related_entity_id], references: [user_id], map: "fk_doc_user")
  documentFlags      DocumentFlag[]
  flags              EvidenceFlag[]
  certification      FacilitatorCertification?         @relation("CertificationDocument")
  pastQualification  PastQualification?                @relation("PastQualificationDocument")
  evidenceLinks      QctoRequestResponseEvidenceLink[]
  sickNoteAttachment SickNote?                         @relation("SickNoteDocument")

  @@index([related_entity, related_entity_id])
  @@index([uploaded_by])
}

model AuditLog {
  audit_id                String          @id @default(uuid())
  entity_type             AuditEntityType
  entity_id               String
  field_name              String
  old_value               String?
  new_value               String?
  changed_by              String
  role_at_time            UserRole
  changed_at              DateTime        @default(now())
  reason                  String?
  institution_id          String?
  change_type             AuditChangeType
  related_submission_id   String?
  related_qcto_request_id String?
  changedBy               User            @relation("AuditChangedBy", fields: [changed_by], references: [user_id])
  institution             Institution?    @relation("InstitutionAuditLogs", fields: [institution_id], references: [institution_id])
  relatedQCTORequest      QCTORequest?    @relation("QCTORequestAuditLogs", fields: [related_qcto_request_id], references: [request_id], map: "fk_audit_qcto_request")
  relatedSubmission       Submission?     @relation("SubmissionAuditLogs", fields: [related_submission_id], references: [submission_id], map: "fk_audit_submission")

  @@index([entity_type, entity_id])
  @@index([changed_by])
  @@index([changed_at])
  @@index([institution_id])
}

model EvidenceFlag {
  flag_id        String    @id @default(uuid())
  document_id    String
  flagged_by     String
  reason         String
  status         String    @default("ACTIVE")
  created_at     DateTime  @default(now())
  resolved_at    DateTime?
  resolved_by    String?
  document       Document  @relation(fields: [document_id], references: [document_id])
  flaggedByUser  User      @relation("EvidenceFlaggedBy", fields: [flagged_by], references: [user_id])
  resolvedByUser User?     @relation("EvidenceResolvedBy", fields: [resolved_by], references: [user_id])

  @@index([document_id])
  @@index([flagged_by])
  @@index([status])
}

model ReviewComment {
  comment_id        String   @id @default(uuid())
  related_entity    String
  related_entity_id String
  comment_by        String
  comment_text      String
  is_internal       Boolean  @default(false)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  commentByUser     User     @relation("ReviewCommentsBy", fields: [comment_by], references: [user_id])

  @@index([related_entity, related_entity_id])
  @@index([comment_by])
  @@index([created_at])
}

model ReadinessRecommendation {
  recommendation_id   String    @id @default(uuid())
  readiness_id        String    @unique
  recommended_by      String
  recommendation      String
  remarks             String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  document_flags      Json?
  review_notes        String?
  reviewer_confidence Int?
  section_scores      Json?
  sme_name            String?
  sme_signature       String?
  verification_date   DateTime?
  verifier_remarks    String?
  readiness           Readiness @relation(fields: [readiness_id], references: [readiness_id])
  recommendedByUser   User      @relation("ReadinessRecommendedBy", fields: [recommended_by], references: [user_id])

  @@index([readiness_id])
  @@index([recommended_by])
  @@index([recommendation])
}

model InstitutionTrustScore {
  score_id        String      @id @default(uuid())
  institution_id  String      @unique
  score           Int
  trend           String?
  explanation     String?
  factors         Json?
  last_calculated DateTime    @default(now())
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  institution     Institution @relation(fields: [institution_id], references: [institution_id])

  @@index([institution_id])
}

model ReadinessSectionReview {
  review_id         String    @id @default(uuid())
  readiness_id      String
  section_name      String
  criterion_key     String?
  reviewer_id       String
  response          String?
  mandatory_remarks String?
  notes             String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  readiness         Readiness @relation(fields: [readiness_id], references: [readiness_id])
  reviewer          User      @relation(fields: [reviewer_id], references: [user_id])

  @@unique([readiness_id, section_name, criterion_key, reviewer_id])
  @@index([readiness_id])
  @@index([reviewer_id])
}

model DocumentFlag {
  flag_id      String     @id @default(uuid())
  document_id  String
  readiness_id String?
  flagged_by   String
  reason       String
  status       String     @default("FLAGGED")
  created_at   DateTime   @default(now())
  resolved_at  DateTime?
  document     Document   @relation(fields: [document_id], references: [document_id])
  flaggedBy    User       @relation(fields: [flagged_by], references: [user_id])
  readiness    Readiness? @relation(fields: [readiness_id], references: [readiness_id])

  @@index([document_id])
  @@index([readiness_id])
  @@index([flagged_by])
}

model Facilitator {
  facilitator_id       String                     @id @default(uuid())
  readiness_id         String
  first_name           String
  last_name            String
  id_number            String?
  qualifications       String?
  industry_experience  String?
  is_non_sa            Boolean                    @default(false)
  saqa_evaluation_id   String?
  work_permit_number   String?
  visa_passport_number String?
  contract_document_id String?
  cv_document_id       String?
  qualification_doc_id String?
  id_document_id       String?
  created_at           DateTime                   @default(now())
  updated_at           DateTime                   @updatedAt
  verification_notes   String?
  verification_status  String?                    @default("PENDING")
  verified_at          DateTime?
  verified_by          String?
  user_id              String?
  documents            Document[]                 @relation("DocumentInstitution")
  readiness            Readiness                  @relation(fields: [readiness_id], references: [readiness_id])
  user                 User?                      @relation("FacilitatorLinkedUser", fields: [user_id], references: [user_id])
  verifiedByUser       User?                      @relation("UserVerifiedFacilitator", fields: [verified_by], references: [user_id])
  certifications       FacilitatorCertification[]
  moduleCompletions    ModuleCompletion[]
  cohorts              Cohort[]                   @relation("CohortToFacilitator")

  @@index([readiness_id])
  @@index([user_id])
  @@index([verification_status])
  @@index([verified_by])
}

/// *
///  * FacilitatorCertification
///  * Tracks certifications, licenses, and professional qualifications for facilitators
model FacilitatorCertification {
  certification_id   String      @id @default(uuid())
  facilitator_id     String
  certification_type String
  certification_name String
  issuing_authority  String?
  certificate_number String?
  issue_date         DateTime?
  expiry_date        DateTime?
  document_id        String?     @unique
  verified           Boolean     @default(false)
  verified_by        String?
  verified_at        DateTime?
  notes              String?
  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt
  document           Document?   @relation("CertificationDocument", fields: [document_id], references: [document_id])
  facilitator        Facilitator @relation(fields: [facilitator_id], references: [facilitator_id], onDelete: Cascade)

  @@index([facilitator_id])
  @@index([expiry_date])
  @@index([certification_type])
  @@index([verified])
}

/// *
///  * Submission (Compliance Pack)
///  * Tracks what institutions submit/share with QCTO.
///  * Supports submission-based QCTO access: QCTO can only view resources linked to submissions.
///  * Workflow:
///  * - Institution creates submission (status: DRAFT)
///  * - Institution adds items (SubmissionItems) which are snapshots of system data
///  * - Institution submits to QCTO (status: SUBMITTED)
///  * - QCTO reviews (status: UNDER_REVIEW)
///  * - QCTO approves/rejects/requests corrections (status: APPROVED / REJECTED / RETURNED_FOR_CORRECTION)
model Submission {
  submission_id          String                            @id @default(uuid())
  institution_id         String
  title                  String?
  submission_type        String?
  status                 SubmissionStatus                  @default(DRAFT)
  submitted_at           DateTime?
  submitted_by           String?
  reviewed_at            DateTime?
  reviewed_by            String?
  review_notes           String?
  created_at             DateTime                          @default(now())
  updated_at             DateTime                          @updatedAt
  deleted_at             DateTime?
  last_activity_at       DateTime?                         @default(now())
  linked_qcto_request_id String?
  notes_to_qcto          String?
  reference_code         String?                           @unique
  auditLogs              AuditLog[]                        @relation("SubmissionAuditLogs")
  linkedQctoRequests     QCTORequest[]
  evidenceLinks          QctoRequestResponseEvidenceLink[]
  institution            Institution                       @relation(fields: [institution_id], references: [institution_id])
  reviewedByUser         User?                             @relation("UserReviewed", fields: [reviewed_by], references: [user_id])
  submittedByUser        User?                             @relation("UserSubmitted", fields: [submitted_by], references: [user_id])
  items                  SubmissionItem[]
  submissionResources    SubmissionResource[]
  reviewAttachments      SubmissionReviewAttachment[]

  @@index([institution_id])
  @@index([status])
  @@index([submitted_at])
  @@index([submitted_by])
  @@index([reviewed_by])
  @@index([reference_code])
}

/// *
///  * SubmissionItem
///  * A "package" of data generated from the system for a specific purpose (Attendance, Results, etc.).
///  * Includes a snapshot of the data at generation time for audit/integrity.
model SubmissionItem {
  submission_item_id       String                            @id @default(uuid())
  submission_id            String
  type                     SubmissionItemType
  status                   SubmissionItemStatus              @default(DRAFT)
  config_json              Json?
  metrics_snapshot_json    Json?
  included_record_ids_json Json?
  data_hash                String?
  generated_at             DateTime?
  created_at               DateTime                          @default(now())
  updated_at               DateTime                          @updatedAt
  evidenceLinks            QctoRequestResponseEvidenceLink[]
  submission               Submission                        @relation(fields: [submission_id], references: [submission_id], onDelete: Cascade)

  @@index([submission_id])
  @@index([type])
  @@index([status])
}

/// *
///  * SubmissionResource
///  * Links resources (readiness, documents, learners, enrolments) to submissions.
///  * This is how we track what QCTO can see - only resources linked to approved/submitted submissions.
///  * (Legacy/Compat: New flows should prefer SubmissionItem snapshots, but this is useful for direct document links)
model SubmissionResource {
  resource_id       String                 @id @default(uuid())
  submission_id     String
  resource_type     SubmissionResourceType
  resource_id_value String
  added_at          DateTime               @default(now())
  added_by          String
  notes             String?
  addedByUser       User                   @relation("UserAddedResource", fields: [added_by], references: [user_id])
  submission        Submission             @relation(fields: [submission_id], references: [submission_id], onDelete: Cascade)

  @@unique([submission_id, resource_type, resource_id_value])
  @@index([submission_id])
  @@index([resource_type, resource_id_value])
  @@index([added_by])
}

/// Attachments added by QCTO reviewers to Review Notes (e.g. supporting docs, screenshots).
model SubmissionReviewAttachment {
  attachment_id   String     @id @default(uuid())
  submission_id   String
  file_name       String
  storage_key     String
  mime_type       String?
  file_size_bytes Int?
  uploaded_by     String
  uploaded_at     DateTime   @default(now())
  submission      Submission @relation(fields: [submission_id], references: [submission_id], onDelete: Cascade)
  uploadedByUser  User       @relation("UserUploadedReviewAttachments", fields: [uploaded_by], references: [user_id])

  @@index([submission_id])
}

/// *
///  * QCTORequest
///  * Tracks QCTO requests to institutions for specific data/information.
model QCTORequest {
  request_id                String                            @id @default(uuid())
  institution_id            String
  requested_by              String
  request_type              String?
  title                     String
  description               String?
  requested_at              DateTime?
  reviewed_at               DateTime?
  reviewed_by               String?
  response_notes            String?
  expires_at                DateTime?
  created_at                DateTime                          @default(now())
  updated_at                DateTime                          @updatedAt
  deleted_at                DateTime?
  response_deadline         DateTime?
  assigned_reviewer_user_id String?
  config_json               Json?
  confirmed_status          String?
  decision                  QctoRequestStatus?
  decision_notes            String?
  due_at                    DateTime?
  linked_submission_id      String?
  reference_code            String?                           @unique
  submitted_at              DateTime?
  type                      QctoRequestType                   @default(CUSTOM)
  status                    QctoRequestStatus                 @default(DRAFT)
  auditLogs                 AuditLog[]                        @relation("QCTORequestAuditLogs")
  assignedReviewer          User?                             @relation("QctoRequestReviewer", fields: [assigned_reviewer_user_id], references: [user_id])
  institution               Institution                       @relation(fields: [institution_id], references: [institution_id])
  linkedSubmission          Submission?                       @relation(fields: [linked_submission_id], references: [submission_id])
  requestedByUser           User                              @relation("QCTORequested", fields: [requested_by], references: [user_id])
  reviewedByUser            User?                             @relation("InstitutionReviewed", fields: [reviewed_by], references: [user_id])
  requestResources          QCTORequestResource[]
  attachments               QctoRequestAttachment[]
  evidenceLinks             QctoRequestResponseEvidenceLink[]

  @@index([institution_id])
  @@index([requested_by])
  @@index([status])
  @@index([requested_at])
  @@index([due_at])
}

/// *
///  * QctoRequestAttachment
///  * Files attached by QCTO when creating the request (e.g. templates, explanation docs).
model QctoRequestAttachment {
  attachment_id      String      @id @default(uuid())
  qcto_request_id    String
  document_id        String?
  file_url           String?
  file_name          String
  file_size          Int?
  created_by_user_id String?
  created_at         DateTime    @default(now())
  request            QCTORequest @relation(fields: [qcto_request_id], references: [request_id], onDelete: Cascade)

  @@index([qcto_request_id])
}

/// *
///  * QctoRequestResponseEvidenceLink
///  * Polymorphic link to Evidence (Submission, SubmissionItem, or Document)
///  * This replaces the legacy QCTORequestResource approach.
model QctoRequestResponseEvidenceLink {
  link_id            String          @id @default(uuid())
  qcto_request_id    String
  submission_id      String?
  submission_item_id String?
  document_id        String?
  created_at         DateTime        @default(now())
  document           Document?       @relation(fields: [document_id], references: [document_id])
  request            QCTORequest     @relation(fields: [qcto_request_id], references: [request_id], onDelete: Cascade)
  submission         Submission?     @relation(fields: [submission_id], references: [submission_id])
  submissionItem     SubmissionItem? @relation(fields: [submission_item_id], references: [submission_item_id])

  @@index([qcto_request_id])
  @@index([submission_id])
  @@index([submission_item_id])
  @@index([document_id])
}

/// *
///  * QCTORequestResource
///  * Links resources to QCTO requests (what QCTO is requesting access to).
///  * Once request is APPROVED, QCTO can view these resources.
model QCTORequestResource {
  resource_id       String                 @id @default(uuid())
  request_id        String
  resource_type     SubmissionResourceType
  resource_id_value String
  added_at          DateTime               @default(now())
  notes             String?
  request           QCTORequest            @relation(fields: [request_id], references: [request_id], onDelete: Cascade)

  @@unique([request_id, resource_type, resource_id_value])
  @@index([request_id])
  @@index([resource_type, resource_id_value])
}

model ServiceRequest {
  id             String               @id @default(uuid())
  service_type   ServiceRequestType
  full_name      String
  email          String
  organization   String?
  phone          String?
  message        String?
  status         ServiceRequestStatus @default(NEW)
  assigned_to    String?
  created_at     DateTime             @default(now())
  updated_at     DateTime             @updatedAt
  assignedToUser User?                @relation("ServiceRequestsAssigned", fields: [assigned_to], references: [user_id])

  @@index([service_type])
  @@index([status])
  @@index([assigned_to])
  @@index([created_at])
}

/// Which user(s) receive notifications for which service type (e.g. sister â†’ accreditation, brother â†’ accounting)
model UserServiceLead {
  user_id      String
  service_type ServiceRequestType
  user         User               @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@id([user_id, service_type])
  @@index([user_id])
  @@index([service_type])
}

model QCTOOrg {
  id         String       @id @default(cuid())
  name       String       @default("QCTO")
  created_at DateTime     @default(now())
  updated_at DateTime     @updatedAt
  invites    QCTOInvite[]
  members    User[]
}

model QCTOInvite {
  id                 String           @id @default(cuid())
  qcto_id            String
  email              String
  full_name          String
  role               UserRole
  token_hash         String           @unique
  status             QCTOInviteStatus @default(PENDING)
  created_at         DateTime         @default(now())
  expires_at         DateTime
  accepted_at        DateTime?
  invited_by_user_id String
  province           String?
  invitedBy          User             @relation("QCTOInviteInvitedBy", fields: [invited_by_user_id], references: [user_id])
  qctoOrg            QCTOOrg          @relation(fields: [qcto_id], references: [id], onDelete: Cascade)

  @@index([qcto_id])
  @@index([qcto_id, status])
  @@index([email])
}

model InviteCampaign {
  campaign_id        String         @id @default(uuid())
  name               String
  status             String         @default("DRAFT")
  audience_type      String
  template_id        String?
  subject            String?
  send_settings      Json?
  sent_count         Int            @default(0)
  opened_count       Int            @default(0)
  clicked_count      Int            @default(0)
  accepted_count     Int            @default(0)
  failed_count       Int            @default(0)
  created_by_user_id String
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  invites            Invite[]
  createdBy          User           @relation("UserCreatedCampaigns", fields: [created_by_user_id], references: [user_id])
  template           EmailTemplate? @relation(fields: [template_id], references: [id])
  events             InviteEvent[]

  @@index([status])
  @@index([created_by_user_id])
}

model InviteEvent {
  event_id    String          @id @default(uuid())
  invite_id   String
  campaign_id String?
  type        String
  metadata    Json?
  created_at  DateTime        @default(now())
  campaign    InviteCampaign? @relation(fields: [campaign_id], references: [campaign_id])
  invite      Invite          @relation(fields: [invite_id], references: [invite_id], onDelete: Cascade)

  @@index([invite_id])
  @@index([campaign_id])
  @@index([type])
  @@index([created_at])
}

enum EngagementState {
  UNCONTACTED
  CONTACTED
  ENGAGED
  EVALUATING
  READY
  ACTIVE
  PAUSED
  DECLINED
  DORMANT
  ARCHIVED
}

model Invite {
  invite_id          String    @id @default(uuid())
  email              String
  role               UserRole
  institution_id     String?
  token_hash         String    @unique
  expires_at         DateTime
  used_at            DateTime?
  created_by_user_id String
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  deleted_at         DateTime?

  // Intelligent Outreach / Engagement Fields
  engagement_state     EngagementState @default(UNCONTACTED)
  engagement_token     String?         @unique // Long-lived token for viewing landing pages (90 days)
  engagement_score_raw Int             @default(0)
  last_interaction_at  DateTime        @default(now())
  engagement_history   Json? // Audit log of state changes

  status               InviteStatus    @default(QUEUED)
  attempts             Int             @default(0)
  max_attempts         Int             @default(3)
  last_attempt_at      DateTime?
  sent_at              DateTime?
  delivered_at         DateTime?
  opened_at            DateTime?
  clicked_at           DateTime?
  accepted_at          DateTime?
  failure_reason       String?
  retry_count          Int             @default(0)
  next_retry_at        DateTime?
  batch_id             String?
  default_province     String?
  custom_message       String?
  decline_reason       String?
  decline_reason_other String?
  declined_at          DateTime?
  template_id          String?
  viewed_at            DateTime?
  campaign_id          String?
  domain               String?
  first_name           String?
  last_name            String?
  organization_label   String?
  token_raw            String?
  phone_number         String?
  accepted_email       String?
  campaign             InviteCampaign? @relation(fields: [campaign_id], references: [campaign_id])
  createdBy            User            @relation("UserCreatedInvites", fields: [created_by_user_id], references: [user_id])
  institution          Institution?    @relation(fields: [institution_id], references: [institution_id])
  template             EmailTemplate?  @relation(fields: [template_id], references: [id])
  events               InviteEvent[]

  @@index([email])
  @@index([institution_id])
  @@index([expires_at])
  @@index([token_hash])
  @@index([created_by_user_id])
  @@index([status])
  @@index([batch_id])
  @@index([next_retry_at])
  @@index([template_id])
  @@index([campaign_id])
  @@index([domain])
  @@index([engagement_state])
  @@index([engagement_token])
}

model EmailTemplate {
  id            String            @id @default(cuid())
  type          EmailTemplateType @unique
  name          String
  subject       String
  header_html   String?
  body_sections Json?
  cta_text      String?
  footer_html   String?
  is_active     Boolean           @default(true)
  created_at    DateTime          @default(now())
  updated_at    DateTime          @updatedAt
  invites       Invite[]
  campaigns     InviteCampaign[]

  @@index([type])
}

/// *
///  * Announcement
///  * System-wide announcements created by platform admins and visible to all users.
///  * Supports priority levels and expiration dates.
model Announcement {
  announcement_id String               @id @default(uuid())
  title           String
  message         String
  priority        AnnouncementPriority @default(MEDIUM)
  status          AnnouncementStatus   @default(ACTIVE)
  created_by      String
  expires_at      DateTime?
  created_at      DateTime             @default(now())
  updated_at      DateTime             @updatedAt
  deleted_at      DateTime?
  created_by_name String
  created_by_role UserRole
  target_roles    UserRole[]           @default([])
  institution_id  String?
  createdByUser   User                 @relation("UserAnnouncements", fields: [created_by], references: [user_id])
  institution     Institution?         @relation(fields: [institution_id], references: [institution_id])

  @@index([status])
  @@index([created_at])
  @@index([expires_at])
  @@index([created_by])
  @@index([institution_id])
}

/// *
///  * OnboardingProgress
///  * Stores draft onboarding data for students before Learner record is created.
///  * Allows resumable onboarding flow.
model OnboardingProgress {
  id                  String    @id @default(uuid())
  user_id             String    @unique
  current_step        Int       @default(1)
  personal_info       Json?
  address_info        Json?
  next_of_kin_info    Json?
  additional_info     Json?
  popia_consent       Boolean?  @default(false)
  popia_consent_date  DateTime?
  past_qualifications Json?
  prior_learning      Json?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  user                User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

/// *
///  * PastQualification
///  * Stores past degrees, certificates, and qualifications that existed before current institution.
///  * Optional data that can be added during onboarding or later in profile.
model PastQualification {
  id             String    @id @default(uuid())
  learner_id     String
  title          String
  institution    String?
  year_completed Int?
  document_id    String?   @unique
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  document       Document? @relation("PastQualificationDocument", fields: [document_id], references: [document_id])
  learner        Learner   @relation(fields: [learner_id], references: [learner_id], onDelete: Cascade)

  @@index([learner_id])
}

/// *
///  * PriorLearning
///  * Stores prior work experience, informal training, or learning that existed before current institution.
///  * Optional data that can be added during onboarding or later in profile.
model PriorLearning {
  id          String    @id @default(uuid())
  learner_id  String
  title       String
  description String?
  institution String?
  start_date  DateTime?
  end_date    DateTime?
  is_current  Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  learner     Learner   @relation(fields: [learner_id], references: [learner_id], onDelete: Cascade)

  @@index([learner_id])
}

/// *
///  * ReviewAssignment
///  * Tracks which reviewers/auditors are assigned to which reviews.
///  * assignment_role: REVIEWER (primary) or AUDITOR; allows one reviewer and optionally one auditor per review.
model ReviewAssignment {
  id              String    @id @default(uuid())
  review_type     String
  review_id       String
  assigned_to     String
  assigned_by     String
  assigned_at     DateTime  @default(now())
  status          String    @default("ASSIGNED")
  completed_at    DateTime?
  notes           String?
  assignment_role String    @default("REVIEWER")
  assigner        User      @relation("ReviewAssignmentsBy", fields: [assigned_by], references: [user_id], onDelete: Cascade)
  reviewer        User      @relation("ReviewAssignments", fields: [assigned_to], references: [user_id], onDelete: Cascade)

  @@unique([review_type, review_id, assigned_to, assignment_role])
  @@index([assigned_to])
  @@index([review_type, review_id])
  @@index([status])
  @@index([assignment_role])
}

model QctoAssignment {
  id                  String               @id @default(uuid())
  resource_type       String
  resource_id         String
  assigned_to_user_id String
  assigned_by_user_id String
  assignment_role     QctoAssignmentRole   @default(REVIEWER)
  status              QctoAssignmentStatus @default(ACTIVE)
  created_at          DateTime             @default(now())
  updated_at          DateTime             @updatedAt
  assignedBy          User                 @relation("QctoAssignmentsAssignedBy", fields: [assigned_by_user_id], references: [user_id], onDelete: Cascade)
  assignedTo          User                 @relation("QctoAssignmentsAssignedTo", fields: [assigned_to_user_id], references: [user_id], onDelete: Cascade)

  @@unique([resource_type, resource_id, assigned_to_user_id, assignment_role])
  @@index([assigned_to_user_id])
  @@index([resource_type, resource_id])
  @@index([status])
}

model InstitutionPublicProfile {
  id                  String                          @id @default(uuid())
  institution_id      String                          @unique
  slug                String                          @unique
  is_public           Boolean                         @default(false)
  tagline             String?
  about               String?
  logo_url            String?
  banner_url          String?
  contact_email       String?
  contact_phone       String?
  contact_visibility  ContactVisibility?              @default(HIDDEN)
  apply_mode          ApplyMode?                      @default(INTERNAL)
  apply_url           String?
  featured_until      DateTime?
  featured_priority   Int                             @default(0)
  verification_status PublicProfileVerificationStatus @default(UNVERIFIED)
  verified_at         DateTime?
  verified_by_user_id String?
  created_at          DateTime                        @default(now())
  updated_at          DateTime                        @updatedAt
  cached_rating_avg   Decimal?                        @db.Decimal(3, 2)
  cached_review_count Int                             @default(0)
  latitude            Float?
  longitude           Float?
  institution         Institution                     @relation(fields: [institution_id], references: [institution_id], onDelete: Cascade)

  @@index([slug])
  @@index([is_public])
  @@index([cached_rating_avg])
  @@index([cached_review_count])
}

model InstitutionPost {
  id             String                @id @default(uuid())
  institution_id String
  type           InstitutionPostType
  title          String
  body           String
  image_url      String?
  video_url      String?
  is_verified    Boolean               @default(false)
  created_at     DateTime              @default(now())
  updated_at     DateTime              @updatedAt
  institution    Institution           @relation(fields: [institution_id], references: [institution_id], onDelete: Cascade)
  flags          InstitutionPostFlag[]

  @@index([institution_id])
  @@index([created_at])
}

model InstitutionPostFlag {
  id         String          @id @default(uuid())
  post_id    String
  user_id    String
  reason     PostFlagReason
  details    String?
  created_at DateTime        @default(now())
  post       InstitutionPost @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([post_id, user_id])
  @@index([post_id])
  @@index([user_id])
}

model InstitutionReview {
  id             String                  @id @default(uuid())
  institution_id String
  user_id        String?
  reviewer_name  String?
  reviewer_email String?
  rating         Int
  comment        String?
  status         InstitutionReviewStatus @default(PUBLISHED)
  created_at     DateTime                @default(now())
  institution    Institution             @relation(fields: [institution_id], references: [institution_id], onDelete: Cascade)
  user           User?                   @relation(fields: [user_id], references: [user_id])

  @@index([institution_id])
  @@index([status])
  @@index([created_at])
}

model InstitutionLead {
  id                      String      @id @default(uuid())
  institution_id          String
  source                  LeadSource
  full_name               String
  email                   String
  phone                   String?
  location                String?
  highest_education_level String?
  qualification_interest  String?
  message                 String?
  status                  LeadStatus  @default(NEW)
  created_at              DateTime    @default(now())
  institution             Institution @relation(fields: [institution_id], references: [institution_id], onDelete: Cascade)

  @@index([institution_id])
  @@index([status])
  @@index([created_at])
}

model ImpersonationSession {
  id              String   @id @default(uuid())
  token           String   @unique
  impersonator_id String
  target_user_id  String
  created_at      DateTime @default(now())
  expires_at      DateTime
  last_activity   DateTime @default(now())
  status          String   @default("ACTIVE")
  ip_address      String?
  user_agent      String?
  impersonator    User     @relation("Impersonations", fields: [impersonator_id], references: [user_id], onDelete: Cascade)
  target_user     User     @relation("Impersonated", fields: [target_user_id], references: [user_id], onDelete: Cascade)

  @@index([token])
  @@index([impersonator_id])
  @@index([target_user_id])
  @@index([status])
  @@index([expires_at])
}

model UserActivityLog {
  id            String   @id @default(uuid())
  user_id       String
  activity_type String
  ip_address    String?
  user_agent    String?
  device_info   String?
  location      String?
  success       Boolean  @default(true)
  created_at    DateTime @default(now())
  user          User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([activity_type])
  @@index([created_at])
  @@index([user_id, created_at])
}

/// *
///  * EmailChangeRequest
///  * Tracks email change requests with verification tokens.
///  * Implements double verification: verify new email + notify old email.
model EmailChangeRequest {
  id            String            @id @default(uuid()) @map("email_change_id")
  user_id       String
  current_email String
  new_email     String
  token_hash    String
  status        EmailChangeStatus @default(PENDING)
  expires_at    DateTime
  verified_at   DateTime?
  cancelled_at  DateTime?
  ip_address    String?
  user_agent    String?
  created_at    DateTime          @default(now())
  user          User              @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([token_hash])
  @@index([status, expires_at])
  @@map("email_change_requests")
}

/// *
///  * BlogPost
///  * Blog posts for the marketing website.
///  * Supports SEO fields, featured images, categories, and tags.
model BlogPost {
  id               String             @id @default(cuid())
  title            String
  slug             String             @unique
  excerpt          String
  content          String
  featuredImage    String?
  featuredImageAlt String?
  metaTitle        String?
  metaDescription  String?
  status           BlogStatus         @default(DRAFT)
  publishedAt      DateTime?
  readingTime      Int?
  authorId         String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  author           User               @relation("BlogPostAuthor", fields: [authorId], references: [user_id])
  categories       BlogPostCategory[]
  tags             BlogPostTag[]

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([authorId])
}

/// *
///  * BlogCategory
///  * Categories for organizing blog posts.
model BlogCategory {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  posts       BlogPostCategory[]

  @@index([slug])
}

/// *
///  * BlogTag
///  * Tags for blog posts (more granular than categories).
model BlogTag {
  id        String        @id @default(cuid())
  name      String
  slug      String        @unique
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  posts     BlogPostTag[]

  @@index([slug])
}

/// *
///  * BlogPostCategory (Junction Table)
///  * Many-to-many relationship between posts and categories.
model BlogPostCategory {
  postId     String
  categoryId String
  category   BlogCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  post       BlogPost     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@index([postId])
  @@index([categoryId])
}

/// *
///  * BlogPostTag (Junction Table)
///  * Many-to-many relationship between posts and tags.
model BlogPostTag {
  postId String
  tagId  String
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

/// *
///  * Conversation
///  * Represents a chat conversation (DM, group, or support thread).
model Conversation {
  id              String               @id @default(cuid())
  type            ConversationType     @default(DIRECT)
  name            String?
  description     String?
  avatarUrl       String?
  createdBy       String
  institutionId   String?
  isSupport       Boolean              @default(false)
  lastMessageAt   DateTime?
  lastMessageText String?
  pinnedMessageId String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  creator         User                 @relation("ConversationCreator", fields: [createdBy], references: [user_id])
  institution     Institution?         @relation("InstitutionSupportChats", fields: [institutionId], references: [institution_id])
  pinnedMessage   Message?             @relation("PinnedMessage", fields: [pinnedMessageId], references: [id])
  members         ConversationMember[]
  messages        Message[]

  @@index([createdBy])
  @@index([institutionId])
  @@index([type])
  @@index([isSupport])
  @@index([lastMessageAt])
}

/// *
///  * ConversationMember
///  * Tracks membership in conversations with read status.
model ConversationMember {
  id             String           @id @default(cuid())
  conversationId String
  userId         String
  role           ConversationRole @default(MEMBER)
  joinedAt       DateTime         @default(now())
  lastReadAt     DateTime?
  lastReadMsgId  String?
  isMuted        Boolean          @default(false)
  isArchived     Boolean          @default(false)
  leftAt         DateTime?
  isPinned       Boolean          @default(false)
  deletedAt      DateTime?
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User             @relation("UserConversations", fields: [userId], references: [user_id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@index([lastReadAt])
}

/// *
///  * Message
///  * Individual chat messages within a conversation.
model Message {
  id             String              @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  messageType    MessageType         @default(TEXT)
  status         MessageStatus       @default(SENT)
  isAdminMessage Boolean             @default(false)
  replyToId      String?
  metadata       Json?
  editedAt       DateTime?
  deletedAt      DateTime?
  createdAt      DateTime            @default(now())
  pinnedIn       Conversation[]      @relation("PinnedMessage")
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        Message?            @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]           @relation("MessageReplies")
  sender         User                @relation("UserMessages", fields: [senderId], references: [user_id])
  attachments    MessageAttachment[]
  reactions      MessageReaction[]

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
}

/// *
///  * MessageAttachment
///  * Files attached to messages.
model MessageAttachment {
  id           String   @id @default(cuid())
  messageId    String
  fileName     String
  fileType     String
  fileSize     Int
  storageKey   String
  thumbnailKey String?
  createdAt    DateTime @default(now())
  message      Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

/// *
///  * MessageReaction
///  * Emoji reactions to messages.
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReactions", fields: [userId], references: [user_id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

/// *
///  * IssueReport
///  * Bug reports and issue tracking submitted by users.
model IssueReport {
  id            String            @id @default(cuid())
  reportedBy    String
  institutionId String?
  category      IssueCategory
  title         String
  description   String
  pageUrl       String?
  status        IssueStatus       @default(OPEN)
  priority      IssuePriority     @default(MEDIUM)
  assignedTo    String?
  internalNotes String?
  resolution    String?
  resolvedAt    DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  attachments   IssueAttachment[]
  assignee      User?             @relation("UserAssignedIssues", fields: [assignedTo], references: [user_id])
  institution   Institution?      @relation("InstitutionIssueReports", fields: [institutionId], references: [institution_id])
  reporter      User              @relation("UserIssueReports", fields: [reportedBy], references: [user_id])

  @@index([reportedBy])
  @@index([institutionId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([createdAt])
}

/// *
///  * IssueAttachment
///  * Screenshots and files attached to issue reports.
model IssueAttachment {
  id         String      @id @default(cuid())
  issueId    String
  fileName   String
  fileType   String
  fileSize   Int
  storageKey String
  createdAt  DateTime    @default(now())
  issue      IssueReport @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
}

/// *
///  * ClientErrorReport
///  * Client-side / application errors reported by the error boundary for platform admin visibility.
model ClientErrorReport {
  id         String   @id @default(uuid())
  message    String
  digest     String?
  path       String?
  user_id    String?
  created_at DateTime @default(now())
  user       User?    @relation(fields: [user_id], references: [user_id])

  @@index([created_at])
  @@index([user_id])
}

model Notification {
  notification_id   String    @id @default(uuid())
  user_id           String
  title             String
  message           String
  entity_type       String?
  entity_id         String?
  is_read           Boolean   @default(false)
  read_at           DateTime?
  created_at        DateTime  @default(now())
  action_link       String?
  category          String?
  channels          String[]  @default(["IN_APP"])
  deleted_at        DateTime?
  institution_id    String?
  priority          String    @default("NORMAL")
  recipient_role    String?
  resource_id       String?
  resource_type     String?
  updated_at        DateTime  @updatedAt
  notification_type String
  user              User      @relation("UserNotifications", fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_read])
  @@index([created_at])
}

model NotificationPreference {
  id             String   @id @default(uuid())
  user_id        String
  category       String
  email_enabled  Boolean  @default(true)
  in_app_enabled Boolean  @default(true)
  sms_enabled    Boolean  @default(false)
  frequency      String   @default("IMMEDIATE")
  updated_at     DateTime @updatedAt
  user           User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, category])
}

model EmailQueue {
  id              String    @id @default(uuid())
  to_email        String
  user_id         String?
  template_id     String?
  subject         String
  body_html       String?
  body_text       String?
  status          String    @default("PENDING")
  attempts        Int       @default(0)
  last_attempt_at DateTime?
  next_attempt_at DateTime?
  sent_at         DateTime?
  error_message   String?
  priority        String    @default("NORMAL")
  scheduled_for   DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  user            User?     @relation(fields: [user_id], references: [user_id])

  @@index([status])
  @@index([next_attempt_at])
  @@index([user_id])
}

model PublicTalentProfile {
  id                   String                  @id @default(uuid())
  user_id              String                  @unique
  slug                 String                  @unique
  is_public            Boolean                 @default(false)
  headline             String?
  bio                  String?
  avatar_url           String?
  banner_url           String?
  primary_location     String?
  open_to_anywhere     Boolean                 @default(false)
  work_type            WorkType                @default(ONSITE)
  contact_visibility   TalentContactVisibility @default(REVEAL_ON_REQUEST)
  public_cv_version_id String?
  created_at           DateTime                @default(now())
  updated_at           DateTime                @updatedAt
  jobRequests          JobOpportunityRequest[]
  public_cv            CvVersion?              @relation(fields: [public_cv_version_id], references: [id])
  user                 User                    @relation(fields: [user_id], references: [user_id])
  likes                TalentLike[]
}

model CvVersion {
  id             String                @id @default(uuid())
  user_id        String
  title          String
  content_json   Json
  pdf_url        String?
  created_at     DateTime              @default(now())
  updated_at     DateTime              @updatedAt
  user           User                  @relation(fields: [user_id], references: [user_id])
  profiles_using PublicTalentProfile[]
}

model TalentLike {
  id               String              @id @default(uuid())
  liked_profile_id String
  user_id          String
  created_at       DateTime            @default(now())
  liked_profile    PublicTalentProfile @relation(fields: [liked_profile_id], references: [id])
  user             User                @relation(fields: [user_id], references: [user_id])

  @@unique([liked_profile_id, user_id])
}

model JobOpportunityRequest {
  id                    String               @id @default(uuid())
  candidate_user_id     String
  candidate_profile_id  String
  company_name          String
  company_email         String
  company_domain        String?
  company_website       String?
  role_title            String
  message               String
  location              String?
  work_type             WorkType?
  status                JobRequestStatus     @default(PENDING_VERIFICATION)
  verification_token    String
  token_expires_at      DateTime
  verified_at           DateTime?
  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt
  publicTalentProfileId String?
  candidate             User                 @relation("JobRequestsCandidate", fields: [candidate_user_id], references: [user_id])
  publicTalentProfile   PublicTalentProfile? @relation(fields: [publicTalentProfileId], references: [id])
}

model SystemSetting {
  key        String   @id
  value      String
  updated_by String?
  updated_at DateTime @updatedAt
}

enum SessionType {
  THEORY
  PRACTICAL
  WBL
  ASSESSMENT
  ORIENTATION
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

enum QualificationType {
  OCCUPATIONAL_CERTIFICATE
  SKILL_PROGRAMME
  LEARNERSHIP
  APPRENTICESHIP
  UNIT_STANDARD
  SHORT_COURSE
  OTHER
}

enum QualificationStatus {
  ACTIVE
  INACTIVE
  RETIRED
  DRAFT
  ARCHIVED
}

enum StudyMode {
  ON_SITE
  ONLINE
  HYBRID
}

enum DurationUnit {
  WEEKS
  MONTHS
  YEARS
}

enum RegulatoryBody {
  QCTO
  SETA
  DHET
  OTHER
}

enum AssessmentType {
  EXAM
  PRACTICAL
  PORTFOLIO
  MIXED
}

enum SubmissionItemType {
  ATTENDANCE
  ENROLMENTS
  ASSESSMENT_RESULTS
  LEARNER_LIST
  POLICIES_AND_EVIDENCE
  OTHER
}

enum SubmissionItemStatus {
  DRAFT
  GENERATED
  NEEDS_INFO
  READY
  LOCKED
}

enum QctoRequestType {
  DOCUMENTS
  ATTENDANCE
  ENROLMENTS
  ASSESSMENT_RESULTS
  READINESS_CLARIFICATION
  CUSTOM
}

enum QctoRequestStatus {
  DRAFT
  SENT
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  RETURNED_FOR_CORRECTION
  REJECTED
  CANCELLED
  PENDING
}

enum UserRole {
  PLATFORM_ADMIN
  QCTO_USER
  INSTITUTION_ADMIN
  INSTITUTION_STAFF
  STUDENT
  QCTO_SUPER_ADMIN
  QCTO_ADMIN
  QCTO_REVIEWER
  QCTO_AUDITOR
  QCTO_VIEWER
  ADVISOR
  FACILITATOR
}

/// Platform-level service request (accreditation help, accounting, marketing, etc.)
enum ServiceRequestType {
  ACCREDITATION_HELP
  ACCOUNTING_SERVICES
  MARKETING_WEBSITES
  GENERAL_INQUIRY
}

enum ServiceRequestStatus {
  NEW
  CONTACTED
  CLOSED
}

/// Role within an institution when user has multiple institutions (UserInstitution).
enum UserInstitutionRole {
  ADMIN
  STAFF
}

enum QCTOInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum InviteStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  ACCEPTED
  FAILED
  RETRYING
  EXPIRED
  DECLINED
}

/// Email template type: invite templates (role-scoped access) and auth templates (Platform Admin only).
enum EmailTemplateType {
  INSTITUTION_ADMIN_INVITE
  INSTITUTION_STAFF_INVITE
  STUDENT_INVITE
  QCTO_INVITE
  PLATFORM_ADMIN_INVITE
  SYSTEM_NOTIFICATION
  AUTH_PASSWORD_RESET
  AUTH_EMAIL_VERIFY
}

enum RecordStatus {
  DRAFT
  APPROVED
  SUSPENDED
}

enum InstitutionType {
  TVET
  PRIVATE_SDP
  NGO
  UNIVERSITY
  OTHER
  EMPLOYER
}

enum DeliveryMode {
  FACE_TO_FACE
  BLENDED
  MOBILE
}

enum ReadinessStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  RETURNED_FOR_CORRECTION
  REVIEWED
  RECOMMENDED
  REJECTED
}

enum AliasSource {
  QCTO
  SAQA
  INSTITUTION
  OTHER
}

enum AnnouncementPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AnnouncementStatus {
  ACTIVE
  ARCHIVED
}

enum EnrolmentStatus {
  ACTIVE
  COMPLETED
  TRANSFERRED
  ARCHIVED
}

enum DocumentRelatedEntity {
  INSTITUTION
  LEARNER
  READINESS
  ENROLMENT
  ATTENDANCE_RECORD
  FACILITATOR
  USER_FACILITATOR_PROFILE
}

enum AuditEntityType {
  INSTITUTION
  USER
  LEARNER
  ENROLMENT
  READINESS
  DOCUMENT
  ATTENDANCE_RECORD
  QCTO_REQUEST
  SUBMISSION_RESOURCE
  SUBMISSION
  QUALIFICATION
  FACILITATOR
  QUALIFICATION_REGISTRY
  EMAIL_TEMPLATE
}

enum DocumentStatus {
  UPLOADED
  FLAGGED
  ACCEPTED
}

enum AuditChangeType {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  RETURNED_FOR_CORRECTION
}

enum SubmissionResourceType {
  READINESS
  LEARNER
  ENROLMENT
  DOCUMENT
  INSTITUTION
  FACILITATOR
  ATTENDANCE_REGISTER
}

enum VerificationLevel {
  NONE
  BLUE
  GREEN
  GOLD
  BLACK
}

/// Generic QCTO assignment: delegates resource access to reviewers/auditors. Used for readiness and future resource types.
enum QctoAssignmentRole {
  REVIEWER
  AUDITOR
}

enum QctoAssignmentStatus {
  ACTIVE
  REMOVED
  COMPLETED
}

/// Public profile for institution directory (opt-in). Verification badge from QCTO later.
enum PublicProfileVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
}

enum ContactVisibility {
  HIDDEN
  REVEAL_ON_CLICK
  PUBLIC
}

enum ApplyMode {
  INTERNAL
  EXTERNAL
  BOTH
}

enum InstitutionPostType {
  ACHIEVEMENT
  UPDATE
}

enum PostFlagReason {
  MISLEADING
  FAKE
  SPAM
  OTHER
}

enum InstitutionReviewStatus {
  PUBLISHED
  HIDDEN
  PENDING
}

enum LeadSource {
  PUBLIC
  STUDENT
}

enum LeadStatus {
  NEW
  CONTACTED
  CLOSED
}

enum EmailChangeStatus {
  PENDING
  VERIFIED
  EXPIRED
  CANCELLED
}

enum BlogStatus {
  DRAFT
  PUBLISHED
}

enum ConversationType {
  DIRECT
  GROUP
  SUPPORT
}

enum ConversationRole {
  MEMBER
  ADMIN
  OWNER
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum IssueCategory {
  BUG
  DATA_ISSUE
  ACCESS_ISSUE
  FEATURE_REQUEST
  OTHER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  WONT_FIX
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkType {
  REMOTE
  ONSITE
  HYBRID
}

enum TalentContactVisibility {
  HIDDEN
  REVEAL_ON_REQUEST
  PUBLIC
}

enum JobRequestStatus {
  PENDING_VERIFICATION
  VERIFIED_SENT
  EXPIRED
  REJECTED
  FLAGGED
  VIEWED
  ARCHIVED
}

/// ==========================================
/// OUTREACH SANDBOX MODELS
/// Isolated environment for testing awareness engine flow.
/// ==========================================

model OutreachSandboxSession {
  session_id        String   @id @default(uuid())
  name              String
  created_by_user_id String
  
  // Simulated Institution State
  institution_name  String
  industry          String?
  province          String?
  current_stage     String   @default("UNCONTACTED") // store enum as string for flexibility or map to Enums
  engagement_score  Int      @default(0)
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  last_activity_at  DateTime @default(now())
  
  // Configuration
  ai_enabled        Boolean  @default(true)
  require_approval  Boolean  @default(false)

  events            OutreachSandboxEvent[]
  messages          OutreachSandboxMessage[]
}

model OutreachSandboxEvent {
  event_id          String   @id @default(uuid())
  session_id        String
  event_type        String   // Mapped to OutreachEventType
  timestamp         DateTime @default(now())
  metadata          Json?    // Stores score delta, specialized info
  description       String?
  
  session           OutreachSandboxSession @relation(fields: [session_id], references: [session_id], onDelete: Cascade)
}

model OutreachSandboxMessage {
  message_id        String   @id @default(uuid())
  session_id        String
  
  // Message Content
  subject           String
  preview_text      String?
  body_html         String
  from_name         String?
  
  // Simulation State
  status            String   // DRAFT, SENT, OPENED, CLICKED
  sent_at           DateTime?
  opened_at         DateTime?
  clicked_at        DateTime?
  
  // Link to Template/AI
  template_id       String?
  ai_draft_id       String?
  
  created_at        DateTime @default(now())
  
  session           OutreachSandboxSession @relation(fields: [session_id], references: [session_id], onDelete: Cascade)
}

/// Outreach Questionnaire Template
model Questionnaire {
  questionnaire_id String    @id @default(uuid())
  slug             String    @unique
  title            String
  description      String
  steps            Json      // Array of QuestionnaireStep
  status           String    @default("DRAFT") // TemplateStatus: DRAFT, PUBLISHED
  created_at       DateTime  @default(now())
  published_at     DateTime?
  responses        QuestionnaireResponse[]

  @@index([slug])
  @@index([status])
}

/// Questionnaire Response from an Institution
model QuestionnaireResponse {
  response_id      String        @id @default(uuid())
  questionnaire_id String
  institution_id   String
  tracking_token   String        @unique
  answers          Json          // Record<string, any>
  completed        Boolean       @default(false)
  submitted_at     DateTime?
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt

  questionnaire    Questionnaire @relation(fields: [questionnaire_id], references: [questionnaire_id])
  institution      Institution   @relation(fields: [institution_id], references: [institution_id])

  @@index([questionnaire_id])
  @@index([institution_id])
}

